# ğŸ“š 1-14 FastAPI + SQLAlchemy CRUD

> **í•™ìŠµ ëª©í‘œ**: FastAPIì™€ SQLAlchemy ORMìœ¼ë¡œ DB ì—°ê²°ëœ CRUD API êµ¬í˜„

---

## ğŸ“ íŒŒì¼ êµ¬ì¡°

| íŒŒì¼ | ì—­í•  |
|-----|-----|
| orm.py | Base í´ë˜ìŠ¤ ì •ì˜ |
| models.py | Item ëª¨ë¸ ì •ì˜ |
| connection.py | DB ì—°ê²° ì„¤ì • |
| typing_prompt.py | í…Œì´ë¸” ìƒì„± ìŠ¤í¬ë¦½íŠ¸ |
| crud.py | CRUD API ì„œë²„ |

### íŒŒì¼ ì—°ê²° ê´€ê³„

| ìˆœì„œ | íŒŒì¼ | ì˜ì¡´ì„± |
|:---:|-----|-------|
| 1 | orm.py | - |
| 2 | models.py | orm.py |
| 3 | connection.py | - |
| 4 | crud.py | models.py + connection.py |

---

## 1ï¸âƒ£ orm.py - Base í´ë˜ìŠ¤

```python
from sqlalchemy.orm import DeclarativeBase

class Base(DeclarativeBase):
    pass
```

---

## 2ï¸âƒ£ models.py - Item ëª¨ë¸

```python
from orm import Base
from sqlalchemy import Integer, String
from sqlalchemy.orm import Mapped, mapped_column

class Item(Base):
    __tablename__ = "items"
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    name: Mapped[str] = mapped_column(String(128))
    price: Mapped[int] = mapped_column(Integer)
```

| ì†ì„± | ì˜ë¯¸ |
|-----|-----|
| `__tablename__` | DB í…Œì´ë¸” ì´ë¦„ |
| `primary_key=True` | ê¸°ë³¸í‚¤, ìë™ ì¦ê°€ |
| `String(128)` | ìµœëŒ€ 128ì |

---

## 3ï¸âƒ£ connection.py - DB ì—°ê²°

```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

DATABASE_URL = "sqlite:///./test.db"
engine = create_engine(DATABASE_URL)

SessionFactory = sessionmaker(
    bind=engine,
    autocommit=False,
    autoflush=False,
    expire_on_commit=False
)
```

| ì˜µì…˜ | ê°’ | ì˜ë¯¸ |
|-----|:---:|-----|
| autocommit | False | ìˆ˜ë™ ì»¤ë°‹ (ì•ˆì „) |
| autoflush | False | ìˆ˜ë™ í”ŒëŸ¬ì‹œ |
| expire_on_commit | False | ì»¤ë°‹ í›„ ê°ì²´ ì‚¬ìš© ê°€ëŠ¥ |

---

## 4ï¸âƒ£ crud.py - CRUD API

### CRUD ìš”ì•½

| ì•½ì | ì˜ë¯¸ | HTTP | ìƒíƒœì½”ë“œ |
|:---:|-----|:---:|:---:|
| C | Create | POST | 201 |
| R | Read | GET | 200 |
| U | Update | PATCH/PUT | 200 |
| D | Delete | DELETE | 204 |

### Create (ìƒì„±)
```python
@app.post("/items", status_code=201)
def create_item_api(body: ItemCreateRequest):
    with SessionFactory() as session:
        new_item = Item(name=body.name, price=body.price)
        session.add(new_item)
        session.commit()
        return new_item
```

### Read (ì¡°íšŒ)
```python
@app.get("/items/{item_id}")
def get_item_api(item_id: int):
    with SessionFactory() as session:
        stmt = select(Item).where(Item.id == item_id)
        item = session.scalar(stmt)
        if item is None:
            raise HTTPException(status_code=404, detail="Not Found")
        return item
```

### Update (ìˆ˜ì •)
```python
@app.patch("/items/{item_id}")
def update_item_api(item_id: int, body: ItemUpdateRequest):
    with SessionFactory() as session:
        stmt = select(Item).where(Item.id == item_id)
        item = session.scalar(stmt)
        if item is None:
            raise HTTPException(status_code=404)
        if body.name: item.name = body.name
        if body.price: item.price = body.price
        session.commit()
        return item
```

### Delete (ì‚­ì œ)
```python
@app.delete("/items/{item_id}", status_code=204)
def delete_item_api(item_id: int):
    with SessionFactory() as session:
        stmt = select(Item).where(Item.id == item_id)
        item = session.scalar(stmt)
        if item is None:
            raise HTTPException(status_code=404)
        session.delete(item)
        session.commit()
```

---

## ğŸ“ í•µì‹¬ ì •ë¦¬

### ì„¸ì…˜ ë©”ì„œë“œ

| ë©”ì„œë“œ | ì—­í•  |
|-------|-----|
| `add(obj)` | ì„¸ì…˜ì— ìƒˆ ê°ì²´ ë“±ë¡ |
| `commit()` | DBì— ë°˜ì˜ |
| `delete(obj)` | ì‚­ì œ ëŒ€ê¸°ì—´ ë“±ë¡ |
| `scalar(stmt)` | ë‹¨ì¼ ê²°ê³¼ ë°˜í™˜ |
| `scalars(stmt).all()` | ì—¬ëŸ¬ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ |

### PATCH vs PUT

| êµ¬ë¶„ | PATCH | PUT |
|:---:|-------|-----|
| ëª©ì  | ë¶€ë¶„ ìˆ˜ì • | ì „ì²´ êµì²´ |
| í•„ë“œ | ì„ íƒì  | í•„ìˆ˜ |

### ğŸ“Œ ì½”ë“œ íë¦„

| ìˆœì„œ | CRUD | ì„¸ì…˜ ë©”ì„œë“œ |
|:---:|------|---------|
| 1 | Create | `add()` â†’ `commit()` |
| 2 | Read | `scalars()` / `scalar()` |
| 3 | Update | ì†ì„± ìˆ˜ì • â†’ `commit()` |
| 4 | Delete | `delete()` â†’ `commit()` |
